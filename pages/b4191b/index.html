<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个 SpringBoot 项目能同时处理多少请求？ | 狂想地</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="01.png">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?8ca2d06ec3457bf39838bbdb9ebf3f6b";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="自建博客">
    
    <link rel="preload" href="/assets/css/0.styles.9b32a9ce.css" as="style"><link rel="preload" href="/assets/js/app.971e7be9.js" as="script"><link rel="preload" href="/assets/js/2.f0b7de72.js" as="script"><link rel="preload" href="/assets/js/51.78f63de6.js" as="script"><link rel="prefetch" href="/assets/js/10.0b6d69c5.js"><link rel="prefetch" href="/assets/js/11.f0e3c64f.js"><link rel="prefetch" href="/assets/js/12.4ec076f9.js"><link rel="prefetch" href="/assets/js/13.7c4dcd47.js"><link rel="prefetch" href="/assets/js/14.e96dc414.js"><link rel="prefetch" href="/assets/js/15.2f47a566.js"><link rel="prefetch" href="/assets/js/16.f1abad64.js"><link rel="prefetch" href="/assets/js/17.ccaa471c.js"><link rel="prefetch" href="/assets/js/18.5ef8afcf.js"><link rel="prefetch" href="/assets/js/19.51d08335.js"><link rel="prefetch" href="/assets/js/20.b7e94ca0.js"><link rel="prefetch" href="/assets/js/21.9a6eb457.js"><link rel="prefetch" href="/assets/js/22.b7875db2.js"><link rel="prefetch" href="/assets/js/23.4f69263c.js"><link rel="prefetch" href="/assets/js/24.7c2cbd29.js"><link rel="prefetch" href="/assets/js/25.088a3f85.js"><link rel="prefetch" href="/assets/js/26.ee51a5c6.js"><link rel="prefetch" href="/assets/js/27.77493a0b.js"><link rel="prefetch" href="/assets/js/28.c034713c.js"><link rel="prefetch" href="/assets/js/29.4b3cc903.js"><link rel="prefetch" href="/assets/js/3.92ee9c9d.js"><link rel="prefetch" href="/assets/js/30.41290193.js"><link rel="prefetch" href="/assets/js/31.ca5c59ca.js"><link rel="prefetch" href="/assets/js/32.fd2a9adc.js"><link rel="prefetch" href="/assets/js/33.52809af8.js"><link rel="prefetch" href="/assets/js/34.d32a6968.js"><link rel="prefetch" href="/assets/js/35.c7a54b7b.js"><link rel="prefetch" href="/assets/js/36.9b0779cc.js"><link rel="prefetch" href="/assets/js/37.e6c0580f.js"><link rel="prefetch" href="/assets/js/38.b90b50ba.js"><link rel="prefetch" href="/assets/js/39.27276226.js"><link rel="prefetch" href="/assets/js/4.1d89f541.js"><link rel="prefetch" href="/assets/js/40.fcd7455f.js"><link rel="prefetch" href="/assets/js/41.84e7a5f6.js"><link rel="prefetch" href="/assets/js/42.ab024f77.js"><link rel="prefetch" href="/assets/js/43.3b5493f4.js"><link rel="prefetch" href="/assets/js/44.6a4f3009.js"><link rel="prefetch" href="/assets/js/45.67b8de99.js"><link rel="prefetch" href="/assets/js/46.419ac801.js"><link rel="prefetch" href="/assets/js/47.2fd34d93.js"><link rel="prefetch" href="/assets/js/48.2074ef58.js"><link rel="prefetch" href="/assets/js/49.ddb24d57.js"><link rel="prefetch" href="/assets/js/5.311aac1c.js"><link rel="prefetch" href="/assets/js/50.23863a5f.js"><link rel="prefetch" href="/assets/js/52.c69e373b.js"><link rel="prefetch" href="/assets/js/53.89ee296c.js"><link rel="prefetch" href="/assets/js/54.80809159.js"><link rel="prefetch" href="/assets/js/55.4b11e6ea.js"><link rel="prefetch" href="/assets/js/56.74a15729.js"><link rel="prefetch" href="/assets/js/6.19988b39.js"><link rel="prefetch" href="/assets/js/7.055bfc60.js"><link rel="prefetch" href="/assets/js/8.6ec347d2.js"><link rel="prefetch" href="/assets/js/9.918fc9ee.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9b32a9ce.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="./img/fi.jpg" alt="狂想地" class="logo"> <span class="site-name can-hide">狂想地</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/backend/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>语言学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/java/" class="nav-link">《Java自学笔记》</a></li><li class="dropdown-subitem"><a href="/note/rust/" class="nav-link">《Rust自学笔记》</a></li></ul></li><li class="dropdown-item"><h4>框架学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/mybatis/" class="nav-link">《Mybatis》</a></li><li class="dropdown-subitem"><a href="/note/spring/" class="nav-link">《Spring》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b4191b/404" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/b4191b/404" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e7ada5/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/5a3d2d/" class="nav-link">ElasticSearch</a></li></ul></div></div><div class="nav-item"><a href="/pages/1a935d/" class="nav-link">网络</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/0f17e6/" class="nav-link">消息队列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/project/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a1902d/" class="nav-link">谷粒商城</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><!----> <span class="title" style="display:;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/b6216e/" class="nav-link">文章</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/backend/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>语言学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/java/" class="nav-link">《Java自学笔记》</a></li><li class="dropdown-subitem"><a href="/note/rust/" class="nav-link">《Rust自学笔记》</a></li></ul></li><li class="dropdown-item"><h4>框架学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/mybatis/" class="nav-link">《Mybatis》</a></li><li class="dropdown-subitem"><a href="/note/spring/" class="nav-link">《Spring》</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title">技术</a> <span class="title" style="display:none;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b4191b/404" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/b4191b/404" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/database/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/e7ada5/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/5a3d2d/" class="nav-link">ElasticSearch</a></li></ul></div></div><div class="nav-item"><a href="/pages/1a935d/" class="nav-link">网络</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/0f17e6/" class="nav-link">消息队列</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目" class="dropdown-title"><a href="/project/" class="link-title">项目</a> <span class="title" style="display:none;">项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a1902d/" class="nav-link">谷粒商城</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><!----> <span class="title" style="display:;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">网站</a></li><li class="dropdown-item"><!----> <a href="/pages/b6216e/" class="nav-link">文章</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>面试题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/2f4eeb/" class="sidebar-link">是否每一个Java程序都有一个jvm</a></li><li><a href="/pages/b4191b/" aria-current="page" class="active sidebar-link">一个 SpringBoot 项目能同时处理多少请求？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b4191b/#创建demo" class="sidebar-link">创建DEMO</a></li><li class="sidebar-sub-header level2"><a href="/pages/b4191b/#答案" class="sidebar-link">答案</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>奇淫技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/java/#《Java自学笔记》" data-v-06225672>《Java自学笔记》</a></li><li data-v-06225672><a href="/note/java/#面试题" data-v-06225672>面试题</a></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">一个 SpringBoot 项目能同时处理多少请求？<!----></h1> <!----> <div class="theme-vdoing-content content__default"><p>一个 SpringBoot 项目，未进行任何特殊配置，全部采用默认设置，这个项目同一时刻，最多能同时处理多少请求？</p> <p>能处理多少呢？</p> <p>我也不知道，但是当问题变成上面这样之后，我找到了探索答案的角度。</p> <p>既然“未进行任何特殊配置”，那我自己搞个 Demo 出来，压一把不就完事了吗？</p> <p>坐稳扶好，准备发车。</p> <h1 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h1> <h2 id="创建demo"><a href="#创建demo" class="header-anchor">#</a> 创建DEMO</h2> <p>小手一抖，先搞个 Demo 出来。</p> <p>这个 Demo 非常的简单，就是通过 idea 创建一个全新的 SpringBoot 项目就行。</p> <p>我的 SpringBoot 版本使用的是 2.7.13。</p> <p>整个项目只有这两个依赖：</p> <p><img src="https://image.bejavaer.top/blog/202308091508182.png" alt="image.png"></p> <p>整个项目也只有两个类，要得就是一个空空如也，一清二白。</p> <p><img src="https://image.bejavaer.top/blog/202308091508483.png" alt="image.png"></p> <p>项目中的 TestController，里面只有一个 getTest 方法，用来测试，方法里面接受到请求之后直接 sleep 一小时。</p> <p>目的就是直接把当前请求线程占着，这样我们才能知道项目中一共有多少个线程可以使用：</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getTest&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getTest</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} 接受到请求:num={}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>项目中的 application.properties 文件也是空的：
<img src="http://image.bejavaer.top/blog/202308091509973.png" alt="image.png"></p> <p>这样，一个“未进行任何特殊配置”的 SpringBoot 不就有了吗？</p> <p>基于这个 Demo，前面的面试题就要变成了：我短时间内不断的调用这个 Demo 的 getTest 方法，最多能调用多少次？</p> <p>问题是不是又变得更加简单了一点？</p> <p>那么前面这个“短时间内不断的调用”，用代码怎么表示呢？</p> <p>很简单，就是在循环中不断的进行接口调用就行了。</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">HttpUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8080/getTest?num=&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//阻塞主线程</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然了，这个地方你用一些压测工具，比如 jmeter 啥的，会显得逼格更高，更专业。我这里就偷个懒，直接上代码了。</p> <h2 id="答案"><a href="#答案" class="header-anchor">#</a> 答案</h2> <p>经过前面的准备工作，Demo 和测试代码都就绪了。</p> <p>接下来就是先把 Demo 跑起来：
<img src="https://image.bejavaer.top/blog/202308091509653.png" alt="image.png"></p> <p>然后跑一把 MainTest。</p> <p>当 MainTest 跑起来之后，Demo 这边就会快速的、大量的输出这样的日志：
<img src="https://image.bejavaer.top/blog/202308091509875.png" alt="image.png"></p> <p>也就是我前面 getTest 方法中写的日志：</p> <p><img src="https://image.bejavaer.top/blog/202308091510854.png" alt="image.png"></p> <p>好，现在我们回到这个问题：</p> <blockquote><p>我短时间内不断的调用这个 Demo 的 getTest 方法，最多能调用多少次？</p></blockquote> <p>来，请你告诉我怎么得到这个问题的答案？</p> <p>我这里就是一个大力出奇迹，直接统计“接受到请求”关键字在日志中出现的次数就行了：</p> <p><img src="https://image.bejavaer.top/blog/202308091510392.png" alt="image.png"></p> <p>很显然，答案就是：
<img src="https://image.bejavaer.top/blog/202308091510631.png" alt="image.png"></p> <p>所以，当面试官问你：一个 SpringBoot 项目能同时处理多少请求？</p> <p>你装作仔细思考之后，笃定的说：200 次。</p> <p>面试官微微点头，并等着你继续说下去。</p> <p>你也暗自欢喜，幸好看了歪歪歪师傅的文章，背了个答案。然后等着面试官继续问其他问题。</p> <p>气氛突然就尴尬了起来。</p> <p>接着，你就回家等通知了。</p> <p>200 次，这个回答是对的，但是你只说 200 次，这个回答就显得有点尬了。</p> <p>重要的是，这个值是怎么来的？</p> <p>所以，下面这一部分，你也要背下来。</p> <h1 id="怎么来的"><a href="#怎么来的" class="header-anchor">#</a> 怎么来的？</h1> <p>在开始探索怎么来的之前，我先问你一个问题，这个 200 个线程，是谁的线程，或者说是谁在管理这个线程？</p> <p>是 SpringBoot 吗？</p> <p>肯定不是，SpringBoot 并不是一个 web 容器。</p> <p>应该是 Tomcat 在管理这 200 个线程。</p> <p>这一点，我们通过线程 Dump 也能进行验证：</p> <p><img src="https://image.bejavaer.top/blog/202308091511189.png" alt="image.png"></p> <p><img src="https://image.bejavaer.top/blog/202308091511790.png" alt="image.png"></p> <p>通过线程 Dump 文件，我们可以知道，大量的线程都在 sleep 状态。而点击这些线程，查看其堆栈消息，可以看到 Tomcat、threads、ThreadPoolExecutor 等关键字：</p> <div class="language- extra-class"><pre class="language-text"><code>at org.apache.Tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1791)
at org.apache.Tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
at org.apache.Tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
at org.apache.Tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
at org.apache.Tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
</code></pre></div><p>基于“短时间内有 200 个请求被立马处理的”这个现象，结合你背的滚瓜烂熟的、非常扎实的线程池知识，你先大胆的猜一个：Tomcat 默认核心线程数是 200。</p> <p>接下来，我们就是要去源码里面验证这个猜测是否正确了。</p> <p>我之前分享过阅读源码的方式，《我试图通过这篇文章，教会你一种阅读源码的方式。》，其中最重要的一条就是打一个有效的断点，然后基于断点处的调用栈去定位源码。</p> <p>这里我再教你一个不用打断点也能获取到调用栈的方法。</p> <p>在前面已经展示过了，就是线程 Dump。</p> <p>右边就是一个线程完整的调用栈：</p> <p><img src="https://image.bejavaer.top/blog/202308091511704.png" alt="image.png"></p> <p>从这个调用栈中，由于我们要找的是 Tomcat 线程池相关的源码，所以第一次出现相关关键字的地方就是这一行：</p> <blockquote><p>org.apache.Tomcat.util.threads.ThreadPoolExecutor.Worker#run</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091512712.png" alt="image.png"></p> <p>然后我们在这一行打上断点。</p> <p>重启项目，开始调试。</p> <p>进入 runWorker 之后，这部分代码看起来就非常眼熟了：</p> <p><img src="https://image.bejavaer.top/blog/202308091512675.png" alt="image.png"></p> <p>简直和 JDK 里面的线程池源码一模一样。</p> <p>如果你熟悉 JDK 线程池源码的话，调试 Tomcat 的线程池，那个感觉，就像是回家一样。</p> <p>如果你不熟悉的话，我建议你尽快去熟悉熟悉。</p> <p>随着断点往下走，在 getTask 方法里面，可以看到关于线程池的几个关键参数：</p> <blockquote><p>org.apache.Tomcat.util.threads.ThreadPoolExecutor#getTask</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091512317.png" alt="image.png"> <img src="https://image.bejavaer.top/blog/202308091512981.png" alt="image.png"></p> <p>corePoolSize，核心线程数，值为 10。</p> <p>maximumPoolSize，最大线程数，值为 200。</p> <p>而且基于 maximumPoolSize 这个参数，你往前翻代码，会发现这个默认值就是 200：</p> <p><img src="https://image.bejavaer.top/blog/202308091512699.png" alt="image.png"></p> <p>好，到这里，你发现你之前猜测的“Tomcat 默认核心线程数是 200”是不对的。</p> <p>但是你一点也不慌，再次结合你背的滚瓜烂熟的、非常扎实的线程池知识。</p> <p>并在心里又默念了一次：当线程池接受到任务之后，先启用核心线程数，再使用队列长度，最后启用最大线程数。</p> <p>因为我们前面验证了，Tomcat 可以同时间处理 200 个请求，而它的线程池核心线程数只有 10，最大线程数是 200。</p> <p>这说明，我前面这个测试用例，把队列给塞满了，从而导致 Tomcat 线程池启用了最大线程数：</p> <p><img src="https://image.bejavaer.top/blog/202308091513992.png" alt="image.png"></p> <p>嗯，一定是这样的！</p> <p>那么，现在的关键问题就是：Tomcat 线程池默认的队列长度是多少呢？</p> <p>在当前的这个 Debug 模式下，队列长度可以通过 Alt+F8 进行查看：</p> <p><img src="https://image.bejavaer.top/blog/202308091513824.png" alt="image.png"></p> <p>wc，这个值是 Integer.MAX_VALUE，这么大？</p> <p>我一共也才 1000 个任务，不可能被占满啊？</p> <p>一个线程池：</p> <ul><li>核心线程数，值为 10。</li> <li>最大线程数，值为 200。</li> <li>队列长度，值为 Integer.MAX_VALUE。
1000 个比较耗时的任务过来之后，应该是只有 10 个线程在工作，然后剩下的 990 个进队列才对啊？</li></ul> <p>难道我八股文背错了？</p> <p>这个时候不要慌，嗦根辣条冷静一下。</p> <p>目前已知的是核心线程数，值为 10。这 10 个线程的工作流程是符合我们认知的。</p> <p>但是第 11 个任务过来的时候，本应该进入队列去排队。</p> <p>现在看起来，是直接启用最大线程数了。</p> <p>所以，我们先把测试用例修改一下：</p> <p><img src="https://image.bejavaer.top/blog/202308091513553.png" alt="image.png"></p> <p>那么问题就来了：最后一个请求到底是怎么提交到线程池里面的？</p> <p>前面说了，Tomcat 的线程池源码和 JDK 的基本一样。</p> <p>往线程池里面提交任务的时候，会执行 execute 这个方法：</p> <blockquote><p>org.apache.Tomcat.util.threads.ThreadPoolExecutor#execute(java.lang.Runnable)</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091513258.png" alt="image.png"></p> <p>对于 Tomcat 它会调用到 executeInternal 这个方法：</p> <blockquote><p>org.apache.Tomcat.util.threads.ThreadPoolExecutor#executeInternal</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091514709.png" alt="image.png"></p> <p>这个方法里面，标号为 ① 的地方，就是判断当前工作线程数是否小于核心线程数，小于则直接调用 addWorker 方法，创建线程。</p> <p>标号为 ② 的地方主要是调用了 offer 方法，看看队列里面是否还能继续添加任务。</p> <p>如果不能继续添加，说明队列满了，则来到标号为 ③ 的地方，看看是否能执行 addWorker 方法，创建非核心线程，即启用最大线程数。</p> <p>把这个逻辑捋顺之后，接下来我们应该去看哪部分的代码，就很清晰了。</p> <p>主要就是去看 workQueue.offer(command) 这个逻辑。</p> <p>如果返回 true 则表示加入到队列，返回 false 则表示启用最大线程数嘛。</p> <p>这个 workQueue 是 TaskQueue，看起来一点也不眼熟：</p> <p><img src="https://image.bejavaer.top/blog/202308091514001.png" alt="image.png"></p> <p>当然不眼熟了，因为这个是 Tomcat 自己基于 LinkedBlockingQueue 搞的一个队列。</p> <p><img src="https://image.bejavaer.top/blog/202308091514983.png" alt="image.png"></p> <p>问题的答案就藏在 TaskQueue 的 offer 方法里面。</p> <p>所以我重点带你盘一下这个 offer 方法：</p> <p>org.apache.Tomcat.util.threads.TaskQueue#offer</p> <p><img src="https://image.bejavaer.top/blog/202308091514685.png" alt="image.png"></p> <p>标号为 ① 的地方，判断了 parent 是否为 null，如果是则直接调用父类的 offer 方法。说明要启用这个逻辑，我们的 parent 不能为 null。</p> <p>那么这个 parent 是什么玩意，从哪里来的呢？</p> <p><img src="https://image.bejavaer.top/blog/202308091515800.png" alt="image.png"></p> <p>parent 就是 Tomcat 线程池，通过其 set 方法可以知道，是在线程池完成初始化之后，进行了赋值。</p> <p>也就是说，你可以理解为，在 Tomcat 的场景下，parent 不会为空。</p> <p>标号为 ② 的地方，调用了 getPoolSizeNoLock 方法：</p> <p><img src="https://image.bejavaer.top/blog/202308091515629.png" alt="image.png"></p> <p>这个方法是获取当前线程池中有多个线程。</p> <p>所以如果这个表达式为 true：</p> <blockquote><p>parent.getPoolSizeNoLock() == parent.getMaximumPoolSize()</p></blockquote> <p>就表明当前线程池的线程数已经是配置的最大线程数了，那就调用 offer 方法，把当前请求放到到队列里面去。</p> <p>标号为 ③ 的地方，是判断已经提交到线程池里面待执行或者正在执行的任务个数，是否比当前线程池的线程数还少。</p> <p>如果是，则说明当前线程池有空闲线程可以执行任务，则把任务放到队列里面去，就会被空闲线程给取走执行。</p> <p>然后，关键的来了，标号为 ④ 的地方。</p> <p>如果当前线程池的线程数比线程池配置的最大线程数还少，则返回 false。</p> <p>前面说了，offer 方法返回 false，会出现什么情况？</p> <p><img src="https://image.bejavaer.top/blog/202308091515276.png" alt="image.png"></p> <p>是不是直接开始到上图中标号为 ③ 的地方，去尝试添加非核心线程了？</p> <p>也就是启用最大线程数这个配置了。</p> <p>所以，朋友们，这个是什么情况？</p> <p>这个情况确实就和我们背的线程池的八股文不一样了啊。</p> <p>**JDK 的线程池，是先使用核心线程数配置，接着使用队列长度，最后再使用最大线程配置。</p> <p><strong>Tomcat 的线程池，就是先使用核心线程数配置，再使用最大线程配置，最后才使用队列长度。</strong></p> <p>所以，以后当面试官给你说：我们聊聊线程池的工作机制吧？</p> <p>你就先追问一句：你是说的 JDK 的线程池呢还是 Tomcat 的线程池呢，因为这两个在运行机制上有一点差异。</p> <p>然后，你就看他的表情。</p> <p>如果透露出一丝丝迟疑，然后轻描淡写的说一句：那就对比着说一下吧。</p> <p>那么恭喜你，在这个题目上开始掌握了一点主动权。</p> <h1 id="加深"><a href="#加深" class="header-anchor">#</a> 加深</h1> <p>最后，为了让你更加深刻的理解到 Tomcat 线程池和 JDK 线程池的不一样，我给你搞一个直接复制过去就能运行的代码。</p> <p>当你把 taskqueue.setParent(executor) 这行代码注释掉的时候，它的运行机制就是 JDK 的线程池。</p> <p>当存在这行代码的时候，它的运行机制就变成了 Tomcat 的线程池。</p> <p>玩去吧。</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">TaskQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">TaskThreadFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TomcatThreadPoolExecutorTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> namePrefix <span class="token operator">=</span> <span class="token string">&quot;歪歪歪-exec-&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> daemon <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskQueue</span> taskqueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TaskThreadFactory</span> tf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskThreadFactory</span><span class="token punctuation">(</span>namePrefix<span class="token punctuation">,</span> daemon<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token constant">NORM_PRIORITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span>
                <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> taskqueue<span class="token punctuation">,</span> tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskqueue<span class="token punctuation">.</span><span class="token function">setParent</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">logStatus</span><span class="token punctuation">(</span>executor<span class="token punctuation">,</span> <span class="token string">&quot;创建任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">logStatus</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TaskQueue</span> queue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TaskQueue</span><span class="token punctuation">)</span> executor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;-:&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;核心线程数:&quot;</span> <span class="token operator">+</span> executor<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot;\t活动线程数:&quot;</span> <span class="token operator">+</span> executor<span class="token punctuation">.</span><span class="token function">getActiveCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot;\t最大线程数:&quot;</span> <span class="token operator">+</span> executor<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot;\t总任务数:&quot;</span> <span class="token operator">+</span> executor<span class="token punctuation">.</span><span class="token function">getTaskCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot;\t当前排队线程数:&quot;</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token string">&quot;\t队列剩余大小:&quot;</span> <span class="token operator">+</span> queue<span class="token punctuation">.</span><span class="token function">remainingCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>等等
如果你之前确实没了解过 Tomcat 线程池的工作机制，那么看到这里的时候也许你会觉得确实是有一点点收获。</p> <p>但是，注意我要说但是了。</p> <p>还记得最开始的时候面试官的问题吗？</p> <p>面试官的原问题就是：一个 SpringBoot 项目能同时处理多少请求？</p> <p>那么请问，前面我讲了这么大一坨 Tomcat 线程池运行原理，这个回答，和这个问题匹配吗？</p> <p>是的，除了最开始提出的 200 这个数值之外，并不匹配，甚至在面试官的眼里完全是答非所问了。</p> <p>所以，为了把这两个“并不匹配”的东西比较顺畅的链接起来，你必须要先回答面试官的问题，然后再开始扩展。</p> <p>比如这样答：一个未进行任何特殊配置，全部采用默认设置的 SpringBoot 项目，这个项目同一时刻最多能同时处理多少请求，取决于我们使用的 web 容器，而 SpringBoot 默认使用的是 Tomcat。</p> <p>Tomcat 的默认核心线程数是 10，最大线程数 200，队列长度是无限长。但是由于其运行机制和 JDK 线程池不一样，在核心线程数满了之后，会直接启用最大线程数。所以，在默认的配置下，同一时刻，可以处理 200 个请求。</p> <p>在实际使用过程中，应该基于服务实际情况和服务器配置等相关消息，对该参数进行评估设置。</p> <p>这个回答就算是差不多了。</p> <h1 id="server-tomcat-max-connections"><a href="#server-tomcat-max-connections" class="header-anchor">#</a> server.tomcat.max-connections</h1> <p>但是，如果很不幸，如果你遇到了我，为了验证你是真的自己去摸索过，还是仅仅只是看了几篇文章，我可能还会追问一下：</p> <p>那么其他什么都不动，如果我仅仅加入 server.tomcat.max-connections=10 这个配置呢，那么这个时候最多能处理多少个请求？</p> <p>你可能就要猜了：10 个。</p> <p>是的，我重新提交 1000 个任务过来，在控制台输出的确实是 10 个，</p> <p><img src="https://image.bejavaer.top/blog/202308091515509.png" alt="image.png"></p> <p>那么 max-connections 这个参数它怎么也能控制请求个数呢？</p> <p>为什么在前面的分析过程中我们并没有注意到这个参数呢？</p> <p>首先我们看一下它的默认值：</p> <p><img src="https://image.bejavaer.top/blog/202308091516922.png" alt="image.png"></p> <p>因为它的默认值是 8192，比最大线程数 200 大，这个参数并没有限制到我们，所以我们没有关注到它。</p> <p>当我们把它调整为 10 的时候，小于最大线程数 200，它就开始变成限制项了。</p> <p>那么 max-connections 这个参数到底是干啥的呢？</p> <p>你先自己去摸索摸索吧。</p> <p>同时，还有这样的一个参数，默认是 100：</p> <blockquote><p>server.tomcat.accept-count=100</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091516105.png" alt="image.png"></p> <p>它又是干什么的呢？</p> <p>“和连接数有关”，我只能提示到这里了，自己去摸索吧。</p> <p>再等等
通过前面的分析，我们知道了，要回答“一个 SpringBoot 项目默认能处理的任务数”，这个问题，得先明确其使用的 web 容器。</p> <p>那么问题又来了：SpringBoot 内置了哪些容器呢？</p> <blockquote><p>Tomcat、Jetty、Netty、Undertow</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091516918.png" alt="image.png"></p> <p>前面我们都是基于 Tomcat 分析的，如果我们换一个容器呢？</p> <p>比如换成 Undertow，这个玩意我只是听过，没有实际使用过，它对我来说就是一个黑盒。</p> <p>管它的，先换了再说。</p> <p>从 Tomcat 换成 Undertow，只需要修改 Maven 依赖即可，其他什么都不需要动：</p> <p><img src="https://image.bejavaer.top/blog/202308091516893.png" alt="image.png"></p> <p>再次启动项目，从日志可以发现已经修改为了 Undertow 容器：</p> <p><img src="https://image.bejavaer.top/blog/202308091516568.png" alt="image.png"></p> <p>此时我再次执行 MainTest 方法，还是提交 1000 个请求：</p> <p><img src="https://image.bejavaer.top/blog/202308091517870.png" alt="image.png"></p> <p>从日志来看，发现只有 48 个请求被处理了。</p> <p>就很懵逼，48 是怎么回事儿，怎么都不是一个整数呢，这让强迫症很难受啊。</p> <p>这个时候你的想法是什么，是不是想要看看 48 这个数字到底是从哪里来的？</p> <p>怎么看？</p> <p>之前找 Tomcat 的 200 的时候不是才教了你的嘛，直接往 Undertow 上套就行了嘛。</p> <p>打线程 Dump，然后看堆栈消息：</p> <p><img src="https://image.bejavaer.top/blog/202308091517962.png" alt="image.png"></p> <p>发现 EnhancedQueueExecutor 这个线程池，接着在这个类里面去找构建线程池时的参数。</p> <p>很容易就找到了这个构造方法：</p> <p><img src="https://image.bejavaer.top/blog/202308091517133.png" alt="image.png"></p> <p>所以，在这里打上断点，重启项目。</p> <p>通过 Debug 可以知道，关键参数都是从 builder 里面来的。</p> <p>而 builder 里面，coreSize 和 maxSize 都是 48，队列长度是 Integer.MAX_VALUE。</p> <p><img src="https://image.bejavaer.top/blog/202308091517063.png" alt="image.png"></p> <p>所以看一下 Builder 里面的 coreSize 是怎么来的。</p> <p>点过来发现 coreSize 的默认值是 16：</p> <p><img src="https://image.bejavaer.top/blog/202308091517248.png" alt="image.png"></p> <p>不要慌，再打断点，再重启项目。</p> <p>然后你会在它的 setCorePoolSize 方法处停下来，而这个方法的入参就是我们要找的 48：</p> <p><img src="https://image.bejavaer.top/blog/202308091517783.png" alt="image.png"></p> <p>顺藤摸瓜，重复几次打断点、重启的动作之后，你会找到 48 是一个名为 WORKER_TASK_CORE_THREADS 的变量，是从这里来的：</p> <p><img src="https://image.bejavaer.top/blog/202308091517431.png" alt="image.png"></p> <p>而 WORKER_TASK_CORE_THREADS 这个变量设置的地方是这样的：</p> <blockquote><p>io.undertow.Undertow#start</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091518838.png" alt="image.png"></p> <p>而这里的 workerThreads 取值是这样的：</p> <blockquote><p>io.undertow.Undertow.Builder#Builder</p></blockquote> <p><img src="https://image.bejavaer.top/blog/202308091518548.png" alt="image.png"></p> <p>取的是机器的 CPU 个数乘以 8。</p> <p><img src="https://image.bejavaer.top/blog/202308091518542.png" alt="image.png"></p> <p>所以我这里是 6*8=48。</p> <p>哦，真相大白，原来 48 是这样来的。</p> <p>没意思。</p> <p>确实没意思，但是既然都已经替换为 Undertow 了，那么你去研究一下它的 NIO ByteBuffer、NIO Channel、BufferPool、XNIO Worker、IO 线程池、Worker 线程池...</p> <p>然后再和 Tomcat 对比着学，</p> <p>就开始有点意思了。</p> <p>转载：公众号：捡田螺的小男孩</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/2f4eeb/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">是否每一个Java程序都有一个jvm</div></a> <a href="/pages/dc9fe2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">List-Map过滤</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/2f4eeb/" class="prev">是否每一个Java程序都有一个jvm</a></span> <span class="next"><a href="/pages/dc9fe2/">List-Map过滤</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/e875ad/"><div>
            安装Rust
            <!----></div></a> <span class="date">11-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/96a6ab/"><div>
            读取 Springboot 的配置
            <!----></div></a> <span class="date">11-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/7bea94/"><div>
            SpringBoot 循环依赖
            <!----></div></a> <span class="date">11-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><!----><div></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.971e7be9.js" defer></script><script src="/assets/js/2.f0b7de72.js" defer></script><script src="/assets/js/51.78f63de6.js" defer></script>
  </body>
</html>
